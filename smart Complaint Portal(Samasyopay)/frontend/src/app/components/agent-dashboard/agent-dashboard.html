<div class="container-fluid py-4">
  <!-- Welcome Header -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h2 class="fw-bold text-dark mb-1">Agent Dashboard</h2>
          <p class="text-muted mb-0">Manage your assigned complaints</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Navigation Tabs -->
  <ul class="nav nav-tabs mb-4">
    <li class="nav-item">
      <button class="nav-link" [class.active]="activeTab === 'dashboard'" (click)="setActiveTab('dashboard')">
        <i class="bi bi-speedometer2"></i> Dashboard
      </button>
    </li>
    <li class="nav-item">
      <button class="nav-link" [class.active]="activeTab === 'complaints'" (click)="setActiveTab('complaints')">
        <i class="bi bi-list-check"></i> All Complaints
      </button>
    </li>
    <li class="nav-item">
      <button class="nav-link" [class.active]="activeTab === 'search'" (click)="setActiveTab('search')">
        <i class="bi bi-search"></i> Search & Filter
      </button>
    </li>
  </ul>

  <!-- Dashboard Tab -->
  <div *ngIf="activeTab === 'dashboard'">
    <!-- Stats Cards -->
    <div class="row mb-4">
    <div class="col-md-3 mb-3">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body text-center">
          <div class="text-primary mb-2">
            <i class="bi bi-clipboard-check" style="font-size: 2rem;"></i>
          </div>
          <h3 class="fw-bold mb-1">{{ stats.total }}</h3>
          <p class="text-muted mb-0">Total Assigned</p>
        </div>
      </div>
    </div>

    <div class="col-md-3 mb-3">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body text-center">
          <div class="text-primary mb-2">
            <i class="bi bi-bookmark" style="font-size: 2rem;"></i>
          </div>
          <h3 class="fw-bold mb-1">{{ stats.assigned }}</h3>
          <p class="text-muted mb-0">Assigned</p>
        </div>
      </div>
    </div>

    <div class="col-md-3 mb-3">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body text-center">
          <div class="text-info mb-2">
            <i class="bi bi-arrow-clockwise" style="font-size: 2rem;"></i>
          </div>
          <h3 class="fw-bold mb-1">{{ stats.inProgress }}</h3>
          <p class="text-muted mb-0">In Progress</p>
        </div>
      </div>
    </div>

    <div class="col-md-3 mb-3">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body text-center">
          <div class="text-success mb-2">
            <i class="bi bi-check-circle" style="font-size: 2rem;"></i>
          </div>
          <h3 class="fw-bold mb-1">{{ stats.resolved }}</h3>
          <p class="text-muted mb-0">Resolved</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Recent Complaints -->
  <div class="row">
    <div class="col-12">
      <div class="card border-0 shadow-sm">
        <div class="card-header bg-white border-0 py-3">
          <div class="d-flex justify-content-between align-items-center">
            <h5 class="fw-bold mb-0">Recent Assigned Complaints</h5>
            <a routerLink="/agent/complaints" class="btn btn-outline-primary btn-sm">
              View All
            </a>
          </div>
        </div>
        <div class="card-body p-0">
          <div *ngIf="loading" class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <p class="text-muted mt-2 mb-0">Loading complaints...</p>
          </div>

          <div *ngIf="!loading && recentComplaints.length === 0" class="text-center py-5">
            <i class="bi bi-clipboard text-muted" style="font-size: 3rem;"></i>
            <h6 class="text-muted mt-3 mb-2">No complaints assigned yet</h6>
            <p class="text-muted mb-0">Complaints will appear here when assigned to you</p>
          </div>

          <div *ngIf="!loading && recentComplaints.length > 0" class="table-responsive">
            <table class="table table-hover mb-0">
              <thead class="table-light">
                <tr>
                  <th class="border-0 fw-semibold">Complaint</th>
                  <th class="border-0 fw-semibold">Type</th>
                  <th class="border-0 fw-semibold">Status</th>
                  <th class="border-0 fw-semibold">Assigned Date</th>
                  <th class="border-0 fw-semibold">Actions</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let complaint of recentComplaints">
                  <td class="align-middle">
                    <div class="fw-semibold mb-1">{{ complaint.title }}</div>
                    <small class="text-muted">
                      {{ complaint.description | slice:0:60 }}{{ complaint.description.length > 60 ? '...' : '' }}
                    </small>
                  </td>
                  <td class="align-middle">
                    <span class="badge bg-light text-dark">
                      {{ complaint.complaintType?.name || 'N/A' }}
                    </span>
                  </td>
                  <td class="align-middle">
                    <span [class]="getStatusClass(complaint.status)">{{ getStatusText(complaint.status) }}</span>
                  </td>
                  <td class="align-middle text-muted">
                    {{ formatDate(complaint.updatedAt) }}
                  </td>
                  <td class="align-middle">
                    <div class="btn-group btn-group-sm">
                      <button class="btn btn-outline-primary" (click)="viewComplaintDetails(complaint)">
                        <i class="bi bi-eye"></i>
                      </button>
                      <button *ngIf="complaint.status === 1 || complaint.status === 2" 
                              class="btn btn-outline-secondary" 
                              (click)="viewComplaintDetails(complaint)">
                        <i class="bi bi-pencil-square"></i>
                      </button>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
  </div>

  <!-- All Complaints Tab -->
  <div *ngIf="activeTab === 'complaints'">
    <h4>All Assigned Complaints</h4>
    <div class="table-responsive">
      <table class="table table-striped">
        <thead>
          <tr>
            <th>Title</th>
            <th>Type</th>
            <th>Status</th>
            <th>Citizen</th>
            <th>Created</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let complaint of complaints">
            <td>{{complaint.title}}</td>
            <td>{{complaint.complaintType?.typeName}}</td>
            <td>
              <span [class]="getStatusClass(complaint.status)">{{getStatusText(complaint.status)}}</span>
            </td>
            <td>{{complaint.citizen?.user?.email || 'N/A'}}</td>
            <td>{{formatDate(complaint.createdAt)}}</td>
            <td>
              <div class="btn-group btn-group-sm me-2">
                <button class="btn btn-outline-primary" (click)="viewComplaintDetails(complaint)">
                  <i class="bi bi-eye"></i>
                </button>
                <button class="btn btn-outline-secondary" 
                        *ngIf="complaint.status === 1 || complaint.status === 2"
                        (click)="viewComplaintDetails(complaint)">
                  <i class="bi bi-pencil-square"></i>
                </button>
              </div>
              <select class="form-select form-select-sm d-inline-block w-auto me-2" 
                      [value]="complaint.status" 
                      (change)="onStatusChange($event, complaint.id)"
                      *ngIf="complaint.status !== 3">
                <option value="1">Assigned</option>
                <option value="2">In Progress</option>
                <option value="3">Resolved</option>
              </select>
              <input type="file" class="form-control form-control-sm d-inline-block w-auto" 
                     (change)="uploadSolution(complaint.id, $event)"
                     accept=".pdf,.doc,.docx,.jpg,.png"
                     *ngIf="complaint.status === 2">
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Search Tab -->
  <div *ngIf="activeTab === 'search'">
    <div class="row">
      <div class="col-md-4">
        <h4>Search & Filter</h4>
        <form (ngSubmit)="searchComplaints()">
          <div class="mb-3">
            <label class="form-label">Complaint Type</label>
            <select class="form-control" [(ngModel)]="searchFilters.typeId" name="typeId">
              <option value="">All Types</option>
              <option *ngFor="let type of complaintTypes" [value]="type.id">{{type.typeName}}</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">From Date</label>
            <input type="date" class="form-control" [(ngModel)]="searchFilters.from" name="from">
          </div>
          <div class="mb-3">
            <label class="form-label">To Date</label>
            <input type="date" class="form-control" [(ngModel)]="searchFilters.to" name="to">
          </div>
          <div class="mb-3">
            <label class="form-label">Citizen Name</label>
            <input type="text" class="form-control" [(ngModel)]="searchFilters.citizenName" name="citizenName" placeholder="Search by citizen name">
          </div>
          <button type="submit" class="btn btn-primary me-2">Search</button>
          <button type="button" class="btn btn-secondary" (click)="clearSearch()">Clear</button>
        </form>
      </div>
      <div class="col-md-8">
        <h4>Search Results</h4>
        <div class="table-responsive">
          <table class="table table-striped">
            <thead>
              <tr>
                <th>Title</th>
                <th>Type</th>
                <th>Status</th>
                <th>Created</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let complaint of complaints">
                <td>{{complaint.title}}</td>
                <td>{{complaint.complaintType?.typeName}}</td>
                <td>
                  <span [class]="getStatusClass(complaint.status)">{{getStatusText(complaint.status)}}</span>
                </td>
                <td>{{formatDate(complaint.createdAt)}}</td>
                <td>
                  <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-primary" (click)="viewComplaintDetails(complaint)">
                      <i class="bi bi-eye"></i>
                    </button>
                    <button class="btn btn-outline-secondary" 
                            *ngIf="complaint.status === 1 || complaint.status === 2"
                            (click)="viewComplaintDetails(complaint)">
                      <i class="bi bi-pencil-square"></i>
                    </button>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Complaint Details Modal -->
  <div class="modal-backdrop fade" [class.show]="selectedComplaint" *ngIf="selectedComplaint" (click)="closeModal()"></div>
  <div class="modal fade" [class.show]="selectedComplaint" [style.display]="selectedComplaint ? 'block' : 'none'" *ngIf="selectedComplaint">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Complaint Details</h5>
          <button type="button" class="btn-close" (click)="closeModal()"></button>
        </div>
        <div class="modal-body">
          <div class="row">
            <div class="col-md-6">
              <h6>{{selectedComplaint.title}}</h6>
              <p>{{selectedComplaint.description}}</p>
              <p><strong>Type:</strong> {{selectedComplaint.complaintType?.typeName}}</p>
              <p><strong>Status:</strong> <span [class]="getStatusClass(selectedComplaint.status)">{{getStatusText(selectedComplaint.status)}}</span></p>
              <p><strong>Created:</strong> {{formatDate(selectedComplaint.createdAt)}}</p>
              <p><strong>Citizen:</strong> {{selectedComplaint.citizen?.user?.email || 'N/A'}}</p>
            </div>
            <div class="col-md-6">
              <h6>Actions</h6>
              <div class="mb-3" *ngIf="selectedComplaint.status !== 3">
                <label class="form-label">Update Status:</label>
                <select class="form-select" [value]="selectedComplaint.status" (change)="onStatusChange($event, selectedComplaint.id)">
                  <option value="1">Assigned</option>
                  <option value="2">In Progress</option>
                  <option value="3">Resolved</option>
                </select>
              </div>
              <div class="mb-3" *ngIf="selectedComplaint.status === 2">
                <label class="form-label">Upload Solution:</label>
                <input type="file" class="form-control" (change)="uploadSolution(selectedComplaint.id, $event)" accept=".pdf,.doc,.docx,.jpg,.png">
              </div>
            </div>
          </div>
          
          <h6>Uploaded Documents:</h6>
          <div class="row" *ngIf="selectedComplaint.complaintDocuments?.length > 0; else noDocuments">
            <div class="col-md-4 mb-2" *ngFor="let doc of selectedComplaint.complaintDocuments">
              <div class="card">
                <div class="card-body p-2">
                  <small class="text-muted">{{doc.type === 0 ? 'Citizen Upload' : 'Solution'}}</small>
                  <div class="fw-semibold">{{doc.fileName}}</div>
                  <small class="text-muted">{{formatDate(doc.uploadedAt)}}</small>
                  <button class="btn btn-sm btn-outline-primary mt-1" (click)="downloadDocument(doc)">
                    <i class="bi bi-download"></i> Download
                  </button>
                </div>
              </div>
            </div>
          </div>
          <ng-template #noDocuments>
            <p class="text-muted">No documents uploaded yet.</p>
          </ng-template>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" (click)="closeModal()">Close</button>
        </div>
      </div>
    </div>
  </div>
</div>
