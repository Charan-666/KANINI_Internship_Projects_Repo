<div class="container-fluid mt-4 mb-5">
  <h2>Admin Dashboard</h2>
  
  <!-- Navigation Tabs -->
  <ul class="nav nav-tabs mb-4">
    <li class="nav-item">
      <button class="nav-link" [class.active]="activeTab === 'dashboard'" (click)="setActiveTab('dashboard')">
        <i class="bi bi-speedometer2"></i> Dashboard
      </button>
    </li>
    <li class="nav-item">
      <button class="nav-link" [class.active]="activeTab === 'users'" (click)="setActiveTab('users')">
        <i class="bi bi-people"></i> User Management
      </button>
    </li>
    <li class="nav-item">
      <button class="nav-link" [class.active]="activeTab === 'complaints'" (click)="setActiveTab('complaints')">
        <i class="bi bi-file-text"></i> Complaints
      </button>
    </li>
    <li class="nav-item">
      <button class="nav-link" [class.active]="activeTab === 'types'" (click)="setActiveTab('types')">
        <i class="bi bi-tags"></i> Complaint Types
      </button>
    </li>
  </ul>

  <!-- Dashboard Overview Tab -->
  <div *ngIf="activeTab === 'dashboard'">
    <div class="mb-4">
      <h3 class="text-center mb-4">Welcome to Admin Dashboard</h3>
      <p class="text-center text-muted mb-5">Manage your system efficiently with these quick access tools</p>
    </div>
    
    <div class="row g-4">
      <div class="col-lg-4 col-md-6">
        <div class="card dashboard-card border-0 shadow-lg h-100" (click)="setActiveTab('users')">
          <div class="card-body text-center p-4">
            <div class="icon-wrapper mb-4">
              <div class="icon-circle bg-primary bg-gradient">
                <i class="bi bi-people text-white" style="font-size: 2.5rem;"></i>
              </div>
            </div>
            <h4 class="card-title fw-bold text-dark mb-3">User Management</h4>
            <p class="card-text text-muted mb-4">Manage agents, users and permissions</p>
            <div class="stats-section">
              <div class="row text-center">
                <div class="col-6">
                  <div class="stat-item">
                    <h5 class="text-primary fw-bold mb-1">{{agents.length}}</h5>
                    <small class="text-muted">Agents</small>
                  </div>
                </div>
                <div class="col-6">
                  <div class="stat-item">
                    <h5 class="text-info fw-bold mb-1">{{users.length}}</h5>
                    <small class="text-muted">Total Users</small>
                  </div>
                </div>
              </div>
            </div>
            <div class="mt-4">
              <span class="btn btn-primary btn-sm px-4">Manage Users</span>
            </div>
          </div>
        </div>
      </div>
      
      <div class="col-lg-4 col-md-6">
        <div class="card dashboard-card border-0 shadow-lg h-100" (click)="setActiveTab('complaints')">
          <div class="card-body text-center p-4">
            <div class="icon-wrapper mb-4">
              <div class="icon-circle bg-success bg-gradient">
                <i class="bi bi-file-text text-white" style="font-size: 2.5rem;"></i>
              </div>
            </div>
            <h4 class="card-title fw-bold text-dark mb-3">All Complaints</h4>
            <p class="card-text text-muted mb-4">View, assign and track complaints</p>
            <div class="stats-section">
              <div class="row text-center">
                <div class="col-6">
                  <div class="stat-item">
                    <h5 class="text-success fw-bold mb-1">{{complaints.length}}</h5>
                    <small class="text-muted">Total</small>
                  </div>
                </div>
                <div class="col-6">
                  <div class="stat-item">
                    <h5 class="text-warning fw-bold mb-1">{{getComplaintStats().pending}}</h5>
                    <small class="text-muted">Pending</small>
                  </div>
                </div>
              </div>
            </div>
            <div class="mt-4">
              <span class="btn btn-success btn-sm px-4">View Complaints</span>
            </div>
          </div>
        </div>
      </div>
      
      <div class="col-lg-4 col-md-6">
        <div class="card dashboard-card border-0 shadow-lg h-100" (click)="setActiveTab('types')">
          <div class="card-body text-center p-4">
            <div class="icon-wrapper mb-4">
              <div class="icon-circle bg-warning bg-gradient">
                <i class="bi bi-tags text-white" style="font-size: 2.5rem;"></i>
              </div>
            </div>
            <h4 class="card-title fw-bold text-dark mb-3">Complaint Types</h4>
            <p class="card-text text-muted mb-4">Manage complaint categories</p>
            <div class="stats-section">
              <div class="row text-center">
                <div class="col-12">
                  <div class="stat-item">
                    <h5 class="text-warning fw-bold mb-1">{{complaintTypes.length}}</h5>
                    <small class="text-muted">Active Types</small>
                  </div>
                </div>
              </div>
            </div>
            <div class="mt-4">
              <span class="btn btn-warning btn-sm px-4">Manage Types</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- User Management Tab -->
  <div *ngIf="activeTab === 'users'">
    <div class="row">
      <div class="col-md-8">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h4>User Management</h4>
          <select class="form-select w-auto" [(ngModel)]="userTypeFilter" (change)="onUserTypeFilterChange()">
            <option value="agents">Agents</option>
            <option value="citizens">Citizens</option>
          </select>
        </div>
        
        <div class="table-responsive">
          <table class="table table-striped">
            <thead>
              <tr>
                <th>Name</th>
                <th>Email</th>
                <th *ngIf="userTypeFilter === 'agents'">Department</th>
                <th *ngIf="userTypeFilter === 'citizens'">Phone</th>
                <th *ngIf="userTypeFilter === 'citizens'">Address</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let user of getDisplayedUsers()">
                <td>{{user.name}}</td>
                <td>{{user.email}}</td>
                <td *ngIf="userTypeFilter === 'agents'">{{user.agentProfile?.department}}</td>
                <td *ngIf="userTypeFilter === 'citizens'">{{user.citizenProfile?.phoneNumber}}</td>
                <td *ngIf="userTypeFilter === 'citizens'">{{user.citizenProfile?.address}}</td>
                <td>
                  <button *ngIf="userTypeFilter === 'agents'" class="btn btn-sm btn-primary me-2" (click)="editAgentData(user)">
                    <i class="bi bi-pencil"></i> Edit
                  </button>
                  <button class="btn btn-sm btn-danger" 
                          (click)="userTypeFilter === 'agents' ? deleteAgent(user.id) : deleteCitizen(user.id)">
                    <i class="bi bi-trash"></i> Delete
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
      
      <div class="col-md-4">
        <!-- Edit Agent Form -->
        <div *ngIf="editAgent">
          <h4>Edit Agent</h4>
          <form #editForm="ngForm" (ngSubmit)="editForm.form.valid && updateAgent()">
            <div class="mb-3">
              <label class="form-label">Name</label>
              <input type="text" class="form-control" [(ngModel)]="editAgent.name" name="editName" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Email</label>
              <input type="email" class="form-control" [(ngModel)]="editAgent.email" name="editEmail" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Password (leave blank to keep current)</label>
              <input type="password" class="form-control" [(ngModel)]="editAgent.password" name="editPassword">
            </div>
            <div class="mb-3">
              <label class="form-label">Department</label>
              <select class="form-control" [(ngModel)]="editAgent.department" name="editDepartment" required>
                <option value="">Select Department</option>
                <option *ngFor="let type of complaintTypes" [value]="type.name">{{type.typeName}}</option>
              </select>
            </div>
            <button type="submit" class="btn btn-success me-2">Update Agent</button>
            <button type="button" class="btn btn-secondary" (click)="cancelEdit()">Cancel</button>
          </form>
        </div>

        <!-- Add Agent Form -->
        <div *ngIf="!editAgent && userTypeFilter === 'agents'">
          <h4>Add New Agent</h4>
          <form #agentForm="ngForm" (ngSubmit)="agentForm.form.valid && addAgent()">
            <div class="mb-3">
              <label class="form-label">Name</label>
              <input type="text" class="form-control" [(ngModel)]="newAgent.name" name="name" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Email</label>
              <input type="email" class="form-control" [(ngModel)]="newAgent.email" name="email" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Password</label>
              <input type="password" class="form-control" [(ngModel)]="newAgent.password" name="password" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Department</label>
              <select class="form-control" [(ngModel)]="newAgent.department" name="department" required>
                <option value="">Select Department</option>
                <option *ngFor="let type of complaintTypes" [value]="type.name">{{type.typeName}}</option>
              </select>
            </div>
            <button type="submit" class="btn btn-primary">Add Agent</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Complaints Tab -->
  <div *ngIf="activeTab === 'complaints'">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h4>All Complaints</h4>
      <div class="d-flex gap-2">
        <span class="badge bg-primary">Total: {{getComplaintStats().total}}</span>
        <span class="badge bg-warning">Pending: {{getComplaintStats().pending}}</span>
        <span class="badge bg-info">Assigned: {{getComplaintStats().assigned}}</span>
        <span class="badge bg-success">Resolved: {{getComplaintStats().resolved}}</span>
      </div>
    </div>
    
    <!-- Filters -->
    <div class="row mb-3">
      <div class="col-md-3">
        <input type="text" class="form-control" placeholder="Search complaints..." 
               [(ngModel)]="searchTerm" (input)="onFilterChange()">
      </div>
      <div class="col-md-2">
        <select class="form-select" [(ngModel)]="statusFilter" (change)="onFilterChange()">
          <option value="">All Status</option>
          <option value="0">Pending</option>
          <option value="1">Assigned</option>
          <option value="2">In Progress</option>
          <option value="3">Resolved</option>
        </select>
      </div>
      <div class="col-md-2">
        <select class="form-select" [(ngModel)]="typeFilter" (change)="onFilterChange()">
          <option value="">All Types</option>
          <option *ngFor="let type of complaintTypes" [value]="type.id">{{type.typeName}}</option>
        </select>
      </div>
      <div class="col-md-2">
        <button class="btn btn-outline-secondary" (click)="clearFilters()">
          <i class="bi bi-x-circle"></i> Clear
        </button>
      </div>
    </div>
    
    <div *ngIf="isLoadingComplaints" class="text-center p-4">
      <div class="spinner-border" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="mt-2">Loading complaints...</p>
    </div>
    
    <div *ngIf="!isLoadingComplaints && (filteredComplaints?.length || 0) === 0" class="alert alert-info">
      <span *ngIf="(complaints?.length || 0) === 0">No complaints found.</span>
      <span *ngIf="(complaints?.length || 0) > 0">No complaints match the current filters.</span>
    </div>
    
    <div *ngIf="!isLoadingComplaints && (filteredComplaints?.length || 0) > 0" class="table-responsive">
      <table class="table table-striped table-hover">
        <thead class="table-dark">
          <tr>
            <th>ID</th>
            <th>Title</th>
            <th>Type</th>
            <th>Status</th>
            <th>Citizen</th>
            <th>Agent</th>
            <th>Created</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let complaint of filteredComplaints; trackBy: trackByComplaintId">
            <td><strong>#{{complaint?.id}}</strong></td>
            <td>
              <div class="text-truncate" style="max-width: 200px;" [title]="complaint?.title">
                {{complaint?.title || 'N/A'}}
              </div>
            </td>
            <td>
              <span class="badge bg-light text-dark">{{complaint?.complaintType?.typeName || 'N/A'}}</span>
            </td>
            <td>
              <span class="badge" [class]="'bg-' + getStatusClass(complaint?.status)">
                {{getStatusText(complaint?.status)}}
              </span>
            </td>
            <td>{{getCitizenEmail(complaint)}}</td>
            <td>{{getAgentName(complaint)}}</td>
            <td>{{complaint?.createdAt | date:'short'}}</td>
            <td>
              <select class="form-select form-select-sm" (change)="onAssignAgent($event, complaint?.id || 0)" 
                      *ngIf="!complaint?.agentId && complaint?.id" style="max-width: 120px;">
                <option value="">Assign</option>
                <option *ngFor="let agent of agents" [value]="agent?.id">{{agent?.name}}</option>
              </select>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Complaint Types Tab -->
  <div *ngIf="activeTab === 'types'">
    <div class="row">
      <div class="col-md-8">
        <h4>Complaint Types</h4>
        <div class="table-responsive">
          <table class="table table-striped">
            <thead>
              <tr>
                <th>Name</th>
                <th>Type Name</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let type of complaintTypes">
                <td>{{type.name}}</td>
                <td>{{type.typeName}}</td>
                <td>
                  <button class="btn btn-sm btn-primary me-2" (click)="editComplaintTypeData(type)">
                    <i class="bi bi-pencil"></i> Edit
                  </button>
                  <button class="btn btn-sm btn-danger" (click)="deleteComplaintType(type.id)">
                    <i class="bi bi-trash"></i> Delete
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
      
      <div class="col-md-4">
        <!-- Edit Complaint Type Form -->
        <div *ngIf="editComplaintType">
          <h4>Edit Complaint Type</h4>
          <form #editTypeForm="ngForm" (ngSubmit)="editTypeForm.form.valid && updateComplaintType()">
            <div class="mb-3">
              <label class="form-label">Name</label>
              <input type="text" class="form-control" [(ngModel)]="editComplaintType.name" name="editTypeName" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Display Name</label>
              <input type="text" class="form-control" [(ngModel)]="editComplaintType.typeName" name="editTypeDisplayName" required>
            </div>
            <button type="submit" class="btn btn-success me-2">Update Type</button>
            <button type="button" class="btn btn-secondary" (click)="cancelComplaintTypeEdit()">Cancel</button>
          </form>
        </div>

        <!-- Add Complaint Type Form -->
        <div *ngIf="!editComplaintType">
          <h4>Add New Complaint Type</h4>
          <form (ngSubmit)="addComplaintType()">
            <div class="mb-3">
              <label class="form-label">Name</label>
              <input type="text" class="form-control" [(ngModel)]="newComplaintType.name" name="name" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Display Name</label>
              <input type="text" class="form-control" [(ngModel)]="newComplaintType.typeName" name="typeName" required>
            </div>
            <button type="submit" class="btn btn-primary">Add Type</button>
          </form>
        </div>
      </div>
    </div>

  </div>
</div>
